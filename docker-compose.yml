services:
  origin-proxy:
    build: .
    restart: unless-stopped
    stop_grace_period: 1s
    volumes:
      - ./src/index.js:/app/src/index.js
      - ./cache/:/app/cache/
    ports:
      - 8090:3001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 3s
      timeout: 10s
      retries: 15
  torrserver:
    image: ghcr.io/yourok/torrserver:latest
    stop_grace_period: 1s
    volumes:
      - ~/ts:/opt/ts
    restart: unless-stopped
  test:
    image: curlimages/curl:8.10.1
    stop_grace_period: 1s
    depends_on:
      origin-proxy:
        condition: service_healthy
    command:
      curl --progress-bar "http://origin-proxy:3001/stream/Blink.Twice.2024.1080p.WEBRip.1400MB.DD5.1.x264-GalaxyRG.mkv?link=fb5dadba6cb9632974bb15e3ed19ad4bfc3b71ea&index=1&play" -o /dev/null
  nginx:
    image: nginx:latest
    stop_grace_period: 1s
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./tmp/:/tmp/cache/:rw
    restart: unless-stopped
